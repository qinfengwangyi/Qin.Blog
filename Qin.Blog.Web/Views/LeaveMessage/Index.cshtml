@{
    ViewBag.Title = "留言页";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@model List<Qin.Blog.Entity.LeaveMessage>

<div class="col-md-8 mainContent">
    <div class="articlelist">
        <div class="article-page">
            <ul>
                <li>共：<span class="total">@ViewBag.Total</span> 条</li>
                <li>已加载：<span class="loaded">@ViewBag.Loaded</span> 条</li>
            </ul>
        </div>
        <div class="leavemsgWrap">

            <div class="article-page">
                <div class="addleavmsg">
                    <h4>留下您想说的吧：</h4>
                    <textarea class="msg-content" placeholder="请输入您的留言(500字以内)" maxlength="500"></textarea>
                    <button class="btn btn-primary">提交</button>
                </div>
            </div>

            <div class="leavemsg-page">
                <div class="article-page">
                    <div class="leavemsg">
                        <p class="msg-header">
                            <a href="#">游客</a>
                            <time>2015-12-30 12:23:34</time>
                        </p>
                        <p>Hello，Welcome to Here。I hava a message。</p>
                        <a class="reply" onclick="show(this)">回复<i class="glyphicon glyphicon-pencil"></i></a>
                        <p class="msgWrap">
                            <textarea class="msg" placeholder="请输入你的意见(500字以内)"></textarea>
                            <button class="btn btn-success">回复</button>
                        </p>
                    </div>
                    <div class="leavemsg">
                        <p class="msg-header">
                            <a href="#">Keefe</a>
                            <time>2016-01-03 12:23:36</time>
                        </p>
                        <p>很高兴收到你的留言，非常的感谢您的建议。</p>
                        <a class="reply" onclick="show(this)">回复<i class="glyphicon glyphicon-pencil"></i></a>
                        <p class="msgWrap">
                            <textarea class="msg" placeholder="请输入你的意见(500字以内)"></textarea>
                            <button class="btn btn-success">回复</button>
                        </p>
                    </div>
                </div>

                @if (Model != null)
                {
                    foreach (var item in Model)
                    {
                        <div class="article-page">
                            <div class="leavemsg">
                                <p class="msg-header">
                                    <a href="#">@item.CreateUser</a>
                                    <time>@item.CreateTime</time>
                                </p>
                                <p>@item.Content</p>
                                <a class="reply" onclick="show(this)">回复<i class="glyphicon glyphicon-pencil"></i></a>
                                <p class="msgWrap">
                                    <textarea class="msg" placeholder="请输入你的意见(500字以内)"></textarea>
                                    <button class="btn btn-success">回复</button>
                                </p>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
    <div class="paginationW">
        @if (ViewBag.Loaded >= ViewBag.Total)
        {
            <button class="more none" disabled>没有更多了</button>
        }
        else
        {
            <button class="more">查看更多</button>
        }
    </div>
</div>



<script src="~/Scripts/template.js" type="text/javascript"></script>
<script src="~/Scripts/jquery.common.js" type="text/javascript"></script>
<script type="text/html" id="leaveMsgTmpl">
    <div class="article-page">
        <div class="leavemsg">
            <p class="msg-header">
                {if CreateUser != null}
                <a href="#">${CreateUser}</a>
                {/if}
                {if CreateUser == null}
                <a href="#">游客</a>
                {/if}
                <time>${CreateTime=='/Date(-1893484800000)/'?"":$.modifiers.formatDate(CreateTime)}</time>
            </p>
            <p>${$.HTMLEncode(Content)}</p>
            <a class="reply" onclick="show(this)">回复<i class="glyphicon glyphicon-pencil"></i></a>
            <p class="msgWrap">
                <textarea class="msg" placeholder="请输入你的意见(500字以内)"></textarea>
                <button class="btn btn-success">回复</button>
            </p>
        </div>
    </div>
</script>
<script>
    var pageIndex;
    $(function () {
        pageIndex = 1;

        $(".addleavmsg .btn-primary").click(function () {
            var msgcontent = $(".msg-content");
            if (msgcontent.val().trim()) {
                $.ajax({
                    url: '/LeaveMessage/Insert',
                    type: 'post',
                    dataType: 'json',
                    data: { content: msgcontent.val() },
                    success: function (data) {
                        if (data.status) {
                            alert(data.message);
                            msgcontent.val('');
                        } else {
                            alert(data.message);
                        }
                    }
                });
            } else {
                alert('不能输入空字符串！');
            }
        });
    });

    $(".more").click(function () {
        pageIndex++;
        Page();
    });

    function Page() {
        $.ajax({
            url: '/LeaveMessage/Pages',
            dataType: 'json',
            data: { PageIndex: pageIndex },
            type: 'post',
            success: function (data) {
                if (data.status) {
                    $(".total").parent().html('共：<span class="total">' + data.total + '</span> 条');
                    $(".article-page .loaded").parent().html('已加载：<span class="loaded">' + (--data.pageindex * data.pagesize + data.curpagecount) + '</span> 条');
                    var leavemsglist = $(".leavemsg-page");
                    $.each(data.data, function (index, element) {
                        leavemsglist.append(TrimPath.processDOMTemplate("leaveMsgTmpl", element));
                    });
                    if ((data.pageindex * data.pagesize + data.curpagecount) >= data.total) {
                        $(".more").addClass('none');
                        $(".more").text("没有更多了").attr("disabled", "disabled");
                    }
                } else {
                    $(".total").parent().html('共：<span class="total">' + 0 + '</span> 条');
                    $(".article-page .loaded").parent().html('已加载：<span class="loaded">' + 0 + '</span> 条');
                    $(".article-page").siblings(".article").remove();
                }
            },
            error: function (data) {
            }
        });
    }

    function show(_this) {
        if ($(_this).children().css('display') != "none") {
            $(_this).children().css({ "display": "none" });
            $(_this).next().removeClass("msgWrapShow");
        } else {
            $(_this).children().css({ "display": "inline-block" });
            $(_this).next().addClass("msgWrapShow");
        }
    }
</script>
